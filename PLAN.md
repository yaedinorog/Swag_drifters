# План разработки MVP: 2D top-down веб-гонка с дрифтом

## 1. Краткое резюме
Собираем MVP как одиночную браузерную игру на **Phaser 3 + TypeScript** для десктопа, с акцентом на ощущение дрифта, одной машиной и одной трассой, пиксель-арт графикой, и онлайн-таблицей рекордов через **Node.js + Express + SQLite**.  
Цель MVP: стабильный игровой цикл `старт -> круги -> финиш -> сохранение результата -> просмотр таблицы рекордов`.

## 2. Цели и критерии успеха
- Игрок может пройти трассу и завершить гонку.
- Управление ощущается как дрифт (контролируемый занос, не “рельсовое” движение).
- Результат круга/заезда отображается и сохраняется.
- Онлайн-рекорды работают (отправка + чтение топа).
- На десктопе игра идет плавно (целевой FPS: 60 на обычном современном ноутбуке).

## 3. Scope (входит / не входит)
Входит:
- 1 машина.
- 1 трасса (замкнутый круг).
- Таймер круга и лучшего времени.
- Дрифт-физика (аркадная, управляемая).
- Онлайн leaderboard.
- Экран меню, экран гонки, экран результатов.
- Базовые звуки (двигатель/скольжение/финиш).

Не входит:
- Боты, мультиплеер, карьера.
- Тюнинг машин.
- Мобильное управление.
- Античит “профессионального уровня”.

## 4. Техническая архитектура

### Клиент
- Стек: `TypeScript + Phaser 3 + Vite`.
- Модули:
- `core/game` (инициализация Phaser, сцены).
- `core/physics` (расчет тяги, бокового скольжения, сцепления).
- `core/track` (контрольные точки, валидация круга).
- `ui/hud` (таймер, скорость, индикатор дрифта).
- `services/api` (работа с backend leaderboard).
- Сцены:
- `BootScene` (загрузка ассетов).
- `MenuScene` (старт).
- `RaceScene` (гонка).
- `ResultScene` (результат + отправка рекорда).

### Сервер
- Стек: `Node.js + Express + SQLite`.
- Структура:
- `server/src/index.ts` (bootstrap).
- `server/src/routes/leaderboard.ts`.
- `server/src/db/schema.sql`.
- `server/src/services/scoreService.ts`.

### Хранение данных
- SQLite таблица `scores`:
- `id` INTEGER PK
- `player_name` TEXT (3-16 символов)
- `track_id` TEXT
- `time_ms` INTEGER
- `created_at` DATETIME

## 5. Публичные интерфейсы/API

### HTTP API
- `GET /api/leaderboard?trackId=<id>&limit=<n>`
- Ответ: массив топ-результатов (по `time_ms` по возрастанию).
- `POST /api/leaderboard`
- Body:
```json
{
  "playerName": "RACER1",
  "trackId": "track_01",
  "timeMs": 74321
}
```
- Валидация:
- `playerName`: 3-16, `[A-Za-z0-9_ ]`
- `timeMs`: 10000..3600000
- `trackId`: whitelist известных трасс.

### Клиентские типы
- `CarState`: position, velocity, heading, angularVelocity.
- `InputState`: throttle, brake, steer.
- `LapState`: lapNumber, lapStartMs, bestLapMs, checkpointsPassed.
- `LeaderboardEntry`: playerName, timeMs, createdAt.

## 6. Логика дрифта (фиксируем реализацию)
- Модель: аркадная top-down физика с разложением скорости на продольную/боковую.
- Шаги обновления каждый кадр:
- Применить тягу/торможение по продольной оси машины.
- Применить руление как изменение угла при достаточной скорости.
- Посчитать боковую скорость и гасить ее коэффициентом сцепления.
- В заносе уменьшать сцепление и повышать угловую инерцию.
- Применить лимиты: max speed, max steer at low speed.
- Параметры конфигом (`carHandling.ts`) для быстрой настройки.
- Индикатор дрифта: активен, когда `|lateralVelocity|` выше порога.

## 7. План работ по этапам

### Этап 1: Базовый каркас (день 1)
- Инициализация monorepo/двух пакетов: `client` и `server`.
- Настройка TypeScript, линтинга, базовых npm-скриптов.
- Заготовка сцен Phaser, черный экран -> меню -> гонка.

### Этап 2: Игровой цикл и трек (день 2)
- Отрисовка трассы и границ.
- Машина, камера, коллизии с границами.
- Чекпоинты и фиксация круга/финиша.
- HUD: скорость, текущий круг, время.

### Этап 3: Дрифт и тюнинг ощущений (день 3)
- Реализация `physics/driftModel`.
- Подбор параметров управляемости.
- Визуальная обратная связь (следы/пыль при дрифте).
- Базовые звуки.

### Этап 4: Leaderboard backend (день 4)
- Express API + SQLite schema/migrations.
- Валидация входных данных.
- Интеграция клиента: отправка результата и чтение топа.
- Экран результатов с топ-10.

### Этап 5: Полировка и релиз MVP (день 5)
- Пиксель-арт ассеты (машина, трасса, UI-элементы).
- Баланс сложности трассы.
- Фиксы производительности и багов.
- Подготовка README и скриптов запуска.

## 8. Тесты и acceptance criteria

### Клиент
- Ручные сценарии:
- Машина разгоняется/тормозит/поворачивает с клавиатуры.
- Занос воспроизводится стабильно на поворотах.
- Нельзя засчитать круг без прохождения всех чекпоинтов.
- После финиша результат корректно отображается.
- Технические проверки:
- Нет критических просадок FPS в типовом заезде.
- Нет зависания при перезапуске гонки.

### Сервер
- API-тесты:
- `POST /leaderboard` принимает валидные данные.
- Некорректные `playerName/timeMs/trackId` отклоняются с 400.
- `GET /leaderboard` возвращает отсортированный лимитированный список.
- Интеграционные:
- Результат из клиента появляется в топе после отправки.

### Критерии приемки MVP
- Полный цикл “сыграть и сохранить рекорд” работает локально без ручных правок.
- В топе корректная сортировка по минимальному времени.
- Дрифт ощущается как отдельная механика, а не просто слабое сцепление.

## 9. Rollout и эксплуатация
- Окружения: `local` и `prod`.
- Логи backend: входящие ошибки валидации и 5xx.
- Бэкап SQLite файла по расписанию (минимум ежедневно).
- Простая защита от спама: rate limit по IP для `POST /leaderboard`.

## 10. Явные допущения и выбранные значения
- Только десктоп-браузеры, управление клавиатурой (`WASD`/стрелки + `Space` для ручника).
- MVP контент: 1 машина, 1 трасса.
- Графика: пиксель-арт (можно начать с временных ассетов).
- Backend: Express + SQLite, один `trackId = track_01` в первой версии.
- Имя игрока вводится перед отправкой результата, без аккаунтов/авторизации.
